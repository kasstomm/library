<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Library - Borrow Book</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<!-- Sidebar placeholder -->
<div id="sidebar-container"></div>

<!-- Main Content -->
<div class="content">
    <h2 class="mb-4">âž• Borrow Book</h2>

    <div class="card p-4 mb-5">
        <form id="borrowForm">
            <div class="mb-3">
                <label class="form-label">Select User</label>
                <select id="userSelect" class="form-select" required></select>
            </div>
            <div class="mb-3">
                <label class="form-label">Select Book</label>
                <select id="bookSelect" class="form-select" required></select>
            </div>
            <button type="submit" class="btn btn-primary">Borrow</button>
        </form>
    </div>

    <div id="responseMessage"></div>
</div>

<script>

    // Load sidebar dynamically
    fetch("sidebar.html")
        .then(res => res.text())
        .then(data => {
            document.getElementById("sidebar-container").innerHTML = data;
        })
        .catch(err => console.error("Sidebar load error:", err));

    const API_USERS = "http://localhost:8080/users";
    const API_BOOKS = "http://localhost:8080/books";

    // Load users
    fetch(API_USERS)
      .then(res => res.json())
      .then(users => {
        const userSelect = document.getElementById("userSelect");
        users.forEach(u => {
          userSelect.innerHTML += `<option value="${u.id}">${u.name}</option>`;
        });
      });

    // Load available books
    fetch(API_BOOKS)
      .then(res => res.json())
      .then(books => {
        const bookSelect = document.getElementById("bookSelect");
        books.filter(b => b.bookStatus === "AVAILABLE")
             .forEach(b => {
          bookSelect.innerHTML += `<option value="${b.id}">${b.title} - ${b.author}</option>`;
        });
      });

    // Handle borrow
    document.getElementById("borrowForm").addEventListener("submit", e => {
      e.preventDefault();
      const userSelect = document.getElementById("userSelect");
      const userId = userSelect.value;
      const selectedUserName = userSelect.options[userSelect.selectedIndex].text;

      const bookSelect = document.getElementById("bookSelect");
      const bookId = bookSelect.value;
      const selectedBookName = bookSelect.options[bookSelect.selectedIndex].text;

      fetch(`${API_USERS}/${userId}/borrow/${bookId}`, {
        method: "POST"
      })
      .then(res => {
        if (!res.ok) throw new Error("Borrow failed");
        return res.json();
      })
      .then(() => {
        document.getElementById("responseMessage").innerHTML =
          `<div class="alert alert-success">
            ðŸ“– "${selectedBookName}" borrowed successfully by ðŸ‘¤ ${selectedUserName}
          </div>`;
        bookSelect.remove(bookSelect.selectedIndex); // usuÅ„ ksiÄ…Å¼kÄ™ z listy dostÄ™pnych
      })
      .catch(err => {
        document.getElementById("responseMessage").innerHTML =
          `<div class="alert alert-danger">${err.message}</div>`;
      });
    });
</script>
</body>
</html>
